<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Entrar • RCC MA Nota 10</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-50 text-slate-900">
  <div id="topbar"></div>

  <main class="max-w-xl mx-auto px-4 py-10">
    <div class="bg-white rounded-2xl border shadow-sm p-6">
      <div class="flex items-center justify-between">
        <h1 class="text-xl font-bold">Acesso</h1>
        <a class="text-sm text-indigo-600 hover:underline" href="/">Voltar</a>
      </div>

      <div class="mt-6 grid gap-3">
        <div class="flex gap-2">
          <button id="tabLogin" class="px-3 py-2 rounded-xl bg-slate-900 text-white text-sm">Entrar</button>
          <button id="tabRegister" class="px-3 py-2 rounded-xl border text-sm hover:bg-slate-50">Criar conta</button>
        </div>

        <div id="msg" class="hidden text-sm"></div>

        <form id="formLogin" class="grid gap-3">
          <label class="grid gap-1">
            <span class="text-sm text-slate-600">WhatsApp</span>
            <input name="whatsapp" class="border rounded-xl px-3 py-2" placeholder="ex: 99999999999" required />
          </label>
          <label class="grid gap-1">
            <span class="text-sm text-slate-600">Senha</span>
            <input name="senha" type="password" class="border rounded-xl px-3 py-2" required />
          </label>
          <button class="mt-1 px-4 py-2 rounded-xl bg-indigo-600 text-white hover:bg-indigo-700">Entrar</button>
          <p class="text-xs text-slate-500">Admin padrão é criado pelo servidor com ADMIN_WHATSAPP/ADMIN_PASSWORD.</p>
        </form>

        <form id="formRegister" class="hidden grid gap-3">
          <label class="grid gap-1">
            <span class="text-sm text-slate-600">Nome</span>
            <input name="nome" class="border rounded-xl px-3 py-2" required />
          </label>
          <label class="grid gap-1">
            <span class="text-sm text-slate-600">WhatsApp</span>
            <input name="whatsapp" class="border rounded-xl px-3 py-2" placeholder="ex: 99999999999" required />
          </label>
          <label class="grid gap-1">
            <span class="text-sm text-slate-600">Senha</span>
            <input name="senha" type="password" class="border rounded-xl px-3 py-2" required />
          </label>
          <button class="mt-1 px-4 py-2 rounded-xl bg-slate-900 text-white hover:bg-slate-800">Criar conta</button>
        </form>
      </div>
    </div>
  </main>

  <script type="module">
    import { apiFetch, renderTopbar, setAuth } from "./app.js";
    renderTopbar();

    const tabLogin = document.querySelector('#tabLogin');
    const tabRegister = document.querySelector('#tabRegister');
    const formLogin = document.querySelector('#formLogin');
    const formRegister = document.querySelector('#formRegister');
    const msg = document.querySelector('#msg');

    function showMessage(text, ok=false){
      msg.classList.remove('hidden');
      msg.className = `text-sm rounded-xl px-3 py-2 ${ok? 'bg-green-50 text-green-700 border border-green-200' : 'bg-red-50 text-red-700 border border-red-200'}`;
      msg.textContent = text;
    }

    function setTab(which){
      const login = which === 'login';
      formLogin.classList.toggle('hidden', !login);
      formRegister.classList.toggle('hidden', login);
      tabLogin.className = login ? 'px-3 py-2 rounded-xl bg-slate-900 text-white text-sm' : 'px-3 py-2 rounded-xl border text-sm hover:bg-slate-50';
      tabRegister.className = !login ? 'px-3 py-2 rounded-xl bg-slate-900 text-white text-sm' : 'px-3 py-2 rounded-xl border text-sm hover:bg-slate-50';
      msg.classList.add('hidden');
    }

    tabLogin.addEventListener('click', () => setTab('login'));
    tabRegister.addEventListener('click', () => setTab('register'));

    formLogin.addEventListener('submit', async (e) => {
      e.preventDefault();
      const fd = new FormData(formLogin);
      try {
        const r = await apiFetch('/api/auth/login', {
          method: 'POST',
          body: JSON.stringify({ whatsapp: fd.get('whatsapp'), senha: fd.get('senha') })
        });
        setAuth(r.token, r.user);
        location.href = r.user?.role === 'ADMIN' ? '/admin' : '/';
      } catch (err) {
        showMessage(err.message);
      }
    });

    formRegister.addEventListener('submit', async (e) => {
      e.preventDefault();
      const fd = new FormData(formRegister);
      try {
        const r = await apiFetch('/api/auth/register', {
          method: 'POST',
          body: JSON.stringify({ nome: fd.get('nome'), whatsapp: fd.get('whatsapp'), senha: fd.get('senha') })
        });
        setAuth(r.token, r.user);
        showMessage('Conta criada! Você já está logado.', true);
        setTimeout(() => location.href = '/', 700);
      } catch (err) {
        showMessage(err.message);
      }
    });
  </script>
</body>
</html>
